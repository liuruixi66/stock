# å¼€å‘è€…æŒ‡å—

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹

### æ–°å¼€å‘è€…å…¥é—¨æµç¨‹

1. **ç¯å¢ƒå‡†å¤‡** (é¢„è®¡æ—¶é—´: 30åˆ†é’Ÿ)
2. **ä»£ç ç†è§£** (é¢„è®¡æ—¶é—´: 2å°æ—¶)  
3. **æœ¬åœ°è°ƒè¯•** (é¢„è®¡æ—¶é—´: 1å°æ—¶)
4. **åŠŸèƒ½å¼€å‘** (æ ¹æ®éœ€æ±‚)

---

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒæ­å»º

### 1. ç³»ç»Ÿè¦æ±‚

```bash
æ“ä½œç³»ç»Ÿ: Linux/macOS/Windows
Python: 3.8+
æ•°æ®åº“: MySQL 8.0+ (å¯é€‰)
IDE: VS Code / PyCharm
Git: 2.0+
```

### 2. ç¯å¢ƒå®‰è£…

**Step 1: å…‹éš†é¡¹ç›®**
```bash
git clone <repository-url>
cd stock-main
```

**Step 2: åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**
```bash
# ä½¿ç”¨ venv
python -m venv venv
source venv/bin/activate  # Linux/macOS
# æˆ–
venv\Scripts\activate     # Windows

# ä½¿ç”¨ conda
conda create -n stock_env python=3.9
conda activate stock_env
```

**Step 3: å®‰è£…ä¾èµ–**
```bash
cd backend
pip install -r requirements.txt

# å¦‚æœæ²¡æœ‰ requirements.txtï¼Œæ‰‹åŠ¨å®‰è£…æ ¸å¿ƒä¾èµ–
pip install django==5.2.4
pip install pandas numpy
pip install django-cors-headers
pip install mysqlclient  # MySQL æ”¯æŒ (å¯é€‰)
pip install tushare      # æ•°æ®æº (å¯é€‰)
```

**Step 4: æ•°æ®åº“é…ç½® (å¯é€‰)**
```bash
# å¦‚æœä½¿ç”¨ MySQL
mysql -u root -p
CREATE DATABASE stockdb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# åœ¨ Django ä¸­
python manage.py migrate
```

**Step 5: å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
```bash
python manage.py runserver 8002
# æˆ–
python start_server.py
```

**Step 6: éªŒè¯å®‰è£…**
```bash
# æµ‹è¯• API
curl http://127.0.0.1:8002/api/backtest/config/

# æµ‹è¯•ä¿¡å·åº“
python signal_library.py
```

---

## ğŸ“ é¡¹ç›®ç»“æ„è¯¦è§£

### ç›®å½•ç»„ç»‡åŸåˆ™

```
stock-main/
â”œâ”€â”€ backend/                 # åç«¯ä»£ç  (ä¸»è¦å¼€å‘åŒºåŸŸ)
â”‚   â”œâ”€â”€ myproject/          # Django é¡¹ç›®é…ç½®
â”‚   â”œâ”€â”€ indicators/         # æŠ€æœ¯æŒ‡æ ‡åº“ (å¯æ‰©å±•)
â”‚   â”œâ”€â”€ è¥¿è’™æ–¯é‡åŒ–å›æµ‹ç³»ç»Ÿ3/  # ç¬¬ä¸‰æ–¹å›æµ‹å¼•æ“
â”‚   â”œâ”€â”€ signal_library.py   # æ ¸å¿ƒä¿¡å·åº“ (ä¸»è¦ä¿®æ”¹)
â”‚   â”œâ”€â”€ backtest_integration.py  # API æ¥å£ (å¸¸ä¿®æ”¹)
â”‚   â”œâ”€â”€ filter_stocks.py    # è‚¡ç¥¨ç­›é€‰ (å¯æ‰©å±•)
â”‚   â”œâ”€â”€ tushare_huoqu.py   # æ•°æ®è·å– (å¯æ‰©å±•)
â”‚   â””â”€â”€ *.csv              # æµ‹è¯•æ•°æ®
â”œâ”€â”€ frontend/               # å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ src/               # æºä»£ç 
â”‚   â””â”€â”€ *.html            # é¡µé¢æ–‡ä»¶
â””â”€â”€ docs/                  # æ–‡æ¡£ (æ–°å¢)
```

### æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

**ğŸ”§ å¿…é¡»äº†è§£çš„æ–‡ä»¶**

1. **signal_library.py** - æ ¸å¿ƒäº¤æ˜“é€»è¾‘
   - `SignalLibrary` ç±»: ä¸»è¦ä¸šåŠ¡é€»è¾‘
   - ä¿¡å·ç”Ÿæˆç®—æ³•: `generate_buy_signal()`, `generate_sell_signal()`
   - äº¤æ˜“æ‰§è¡Œ: `execute_buy_trade()`, `execute_sell_trade()`

2. **backtest_integration.py** - API æ¥å£å±‚
   - `run_backtest_api()`: ä¸»è¦ API ç«¯ç‚¹
   - `get_backtest_config_api()`: é…ç½®æ¥å£
   - JSON å“åº”æ ¼å¼å®šä¹‰

3. **myproject/settings.py** - Django é…ç½®
   - æ•°æ®åº“é…ç½®
   - CORS è®¾ç½®
   - ä¸­é—´ä»¶é…ç½®

**ğŸ“Š å¯æ‰©å±•çš„æ–‡ä»¶**

1. **indicators/** - æŠ€æœ¯æŒ‡æ ‡åº“
   - æ¯ä¸ªæŒ‡æ ‡ä¸€ä¸ªæ–‡ä»¶
   - æ ‡å‡†åŒ–çš„æ¥å£è§„èŒƒ
   - ä¾¿äºæ·»åŠ æ–°æŒ‡æ ‡

2. **filter_stocks.py** - è‚¡ç¥¨ç­›é€‰
   - åŸºäºå„ç§æ¡ä»¶ç­›é€‰è‚¡ç¥¨
   - æ”¯æŒè‡ªå®šä¹‰ç­›é€‰è§„åˆ™

3. **tushare_huoqu.py** - æ•°æ®æºæ¥å£
   - æ”¯æŒå¤šç§æ•°æ®æº
   - æ ‡å‡†åŒ–æ•°æ®æ ¼å¼

---

## ğŸ§© ä»£ç æ¶æ„ç†è§£

### 1. æ ¸å¿ƒç±»è®¾è®¡

**SignalLibrary ç±» (signal_library.py)**

```python
class SignalLibrary:
    """
    äº¤æ˜“ä¿¡å·åº“ - ç³»ç»Ÿæ ¸å¿ƒç±»
    
    ä¸»è¦èŒè´£:
    1. ä¿¡å·ç”Ÿæˆ - åŸºäºæŠ€æœ¯æŒ‡æ ‡ç”Ÿæˆä¹°å–ä¿¡å·
    2. äº¤æ˜“æ‰§è¡Œ - æ¨¡æ‹ŸçœŸå®äº¤æ˜“è¿‡ç¨‹
    3. è´¦æˆ·ç®¡ç† - èµ„é‡‘å’ŒæŒä»“ç®¡ç†
    4. å†å²è®°å½• - äº¤æ˜“è®°å½•å’Œç»Ÿè®¡
    """
    
    def __init__(self, initial_balance=100000):
        self.initial_balance = initial_balance
        self.current_balance = initial_balance
        self.positions = {}  # æŒä»“: {è‚¡ç¥¨ä»£ç : {shares, avg_price}}
        self.signal_history = []  # ä¿¡å·å†å²
        
    # æ ¸å¿ƒæ–¹æ³•
    def generate_buy_signal(self, stock_code, df, signal_type='basic'):
        """ç”Ÿæˆä¹°å…¥ä¿¡å·"""
        
    def generate_sell_signal(self, stock_code, df, signal_type='basic'):
        """ç”Ÿæˆå–å‡ºä¿¡å·"""
        
    def execute_buy_trade(self, stock_code, price, shares, trade_date):
        """æ‰§è¡Œä¹°å…¥äº¤æ˜“"""
        
    def execute_sell_trade(self, stock_code, price, shares, trade_date):
        """æ‰§è¡Œå–å‡ºäº¤æ˜“"""
```

### 2. ä¿¡å·ç”Ÿæˆæµç¨‹

```python
def signal_generation_workflow():
    """
    ä¿¡å·ç”Ÿæˆå·¥ä½œæµç¨‹
    
    1. æ•°æ®å‡†å¤‡
       â””â”€ åŠ è½½è‚¡ç¥¨ OHLCV æ•°æ®
    
    2. æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
       â”œâ”€ è°ƒç”¨ indicators æ¨¡å—
       â”œâ”€ è®¡ç®— MA, MACD, KDJ ç­‰
       â””â”€ è¿”å›æŒ‡æ ‡æ•°æ®
    
    3. ä¿¡å·åˆ¤æ–­
       â”œâ”€ åŸºäºæŒ‡æ ‡æ•°å€¼åˆ¤æ–­
       â”œâ”€ åº”ç”¨äº¤æ˜“è§„åˆ™
       â””â”€ ç”Ÿæˆä¿¡å·åºåˆ—
    
    4. ä¿¡å·è®°å½•
       â”œâ”€ è®°å½•ä¿¡å·è¯¦æƒ…
       â”œâ”€ æ‰§è¡Œæ¨¡æ‹Ÿäº¤æ˜“
       â””â”€ æ›´æ–°è´¦æˆ·çŠ¶æ€
    """
    pass
```

### 3. API è¯·æ±‚å¤„ç†æµç¨‹

```python
def api_request_workflow():
    """
    API è¯·æ±‚å¤„ç†å·¥ä½œæµç¨‹
    
    å‰ç«¯è¯·æ±‚ â†’ Django URL è·¯ç”± â†’ è§†å›¾å‡½æ•° â†’ ä¸šåŠ¡é€»è¾‘ â†’ æ•°æ®åº“ â†’ å“åº”
    
    è¯¦ç»†æ­¥éª¤:
    1. å‰ç«¯å‘é€ HTTP è¯·æ±‚
    2. Django æ ¹æ® urls.py æ‰¾åˆ°å¯¹åº”è§†å›¾
    3. è§†å›¾å‡½æ•°è§£æè¯·æ±‚å‚æ•°
    4. è°ƒç”¨ä¸šåŠ¡é€»è¾‘ (SignalLibrary)
    5. æ‰§è¡Œæ•°æ®åº“æ“ä½œ (å¦‚éœ€è¦)
    6. ç»„è£… JSON å“åº”
    7. è¿”å›ç»™å‰ç«¯
    """
    pass
```

---

## ğŸ”¨ å¼€å‘è§„èŒƒ

### 1. ä»£ç é£æ ¼

**Python ä»£ç è§„èŒƒ (PEP 8)**

```python
# âœ… å¥½çš„å‘½å
def calculate_moving_average(prices, window=20):
    """è®¡ç®—ç§»åŠ¨å¹³å‡çº¿"""
    return prices.rolling(window=window).mean()

class TechnicalIndicator:
    """æŠ€æœ¯æŒ‡æ ‡åŸºç±»"""
    
    def __init__(self, period=14):
        self.period = period
    
    def calculate(self, data):
        raise NotImplementedError

# âŒ é¿å…çš„å‘½å
def calc_ma(p, w=20):  # åç§°å¤ªçŸ­
    return p.rolling(window=w).mean()

def CalculateMovingAverage():  # å‡½æ•°åä¸åº”è¯¥ç”¨ CamelCase
    pass
```

**æ³¨é‡Šè§„èŒƒ**

```python
def generate_macd_signal(df, fast=12, slow=26, signal=9):
    """
    ç”Ÿæˆ MACD äº¤æ˜“ä¿¡å·
    
    Args:
        df (pd.DataFrame): åŒ…å« CLOSE åˆ—çš„ä»·æ ¼æ•°æ®
        fast (int): å¿«é€Ÿ EMA å‘¨æœŸï¼Œé»˜è®¤ 12
        slow (int): æ…¢é€Ÿ EMA å‘¨æœŸï¼Œé»˜è®¤ 26  
        signal (int): ä¿¡å·çº¿å‘¨æœŸï¼Œé»˜è®¤ 9
    
    Returns:
        pd.Series: ä¹°å…¥ä¿¡å·åºåˆ—ï¼Œä¹°å…¥æ—¶ä¸º 15ï¼Œå…¶ä»–ä¸º None
        
    Example:
        >>> df = pd.read_csv('000001_10years.csv')
        >>> signals = generate_macd_signal(df)
        >>> print(f"ç”Ÿæˆ {signals.notna().sum()} ä¸ªä¿¡å·")
    """
    # è®¡ç®— MACD æŒ‡æ ‡
    macd_result = macd.calculate(df, fast, slow, signal)
    dif, dea = macd_result[0], macd_result[1]
    
    # åˆ¤æ–­é‡‘å‰ä¿¡å·: DIF ä¸Šç©¿ DEA
    golden_cross = ((dif.shift(1) <= dea.shift(1)) & (dif > dea))
    
    # ç”Ÿæˆä¿¡å·åºåˆ—
    return golden_cross.apply(lambda x: 15 if x else None)
```

### 2. é”™è¯¯å¤„ç†

**ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å¼**

```python
def safe_execute_trade(self, action, stock_code, price, shares):
    """
    å®‰å…¨çš„äº¤æ˜“æ‰§è¡Œï¼ŒåŒ…å«å®Œæ•´é”™è¯¯å¤„ç†
    """
    try:
        # å‚æ•°éªŒè¯
        if not stock_code or not isinstance(stock_code, str):
            raise ValueError("è‚¡ç¥¨ä»£ç å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²")
        
        if price <= 0:
            raise ValueError("è‚¡ç¥¨ä»·æ ¼å¿…é¡»å¤§äº 0")
            
        if shares <= 0:
            raise ValueError("è‚¡ç¥¨æ•°é‡å¿…é¡»å¤§äº 0")
        
        # æ‰§è¡Œäº¤æ˜“
        if action == 'buy':
            result = self.execute_buy_trade(stock_code, price, shares)
        elif action == 'sell':
            result = self.execute_sell_trade(stock_code, price, shares)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„äº¤æ˜“æ“ä½œ: {action}")
        
        return result
        
    except ValueError as e:
        logger.warning(f"å‚æ•°é”™è¯¯: {e}")
        return {'success': False, 'reason': f'å‚æ•°é”™è¯¯: {e}'}
        
    except Exception as e:
        logger.error(f"äº¤æ˜“æ‰§è¡Œå¼‚å¸¸: {e}", exc_info=True)
        return {'success': False, 'reason': f'ç³»ç»Ÿé”™è¯¯: {e}'}
```

**API é”™è¯¯å“åº”æ ‡å‡†**

```python
def standardized_api_response(view_func):
    """
    æ ‡å‡†åŒ– API å“åº”è£…é¥°å™¨
    """
    def wrapper(request, *args, **kwargs):
        try:
            result = view_func(request, *args, **kwargs)
            
            # ç¡®ä¿è¿”å›æ ‡å‡†æ ¼å¼
            if isinstance(result, dict):
                return JsonResponse({
                    'status': 'success',
                    'data': result,
                    'timestamp': datetime.now().isoformat()
                })
            return result
            
        except ValidationError as e:
            return JsonResponse({
                'status': 'error',
                'error_code': 'VALIDATION_ERROR',
                'message': str(e),
                'timestamp': datetime.now().isoformat()
            }, status=400)
            
        except Exception as e:
            logger.error(f"API å¼‚å¸¸: {e}", exc_info=True)
            return JsonResponse({
                'status': 'error',
                'error_code': 'INTERNAL_ERROR',
                'message': 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
                'timestamp': datetime.now().isoformat()
            }, status=500)
    
    return wrapper
```

### 3. æµ‹è¯•è§„èŒƒ

**å•å…ƒæµ‹è¯•ç¤ºä¾‹**

```python
import unittest
from signal_library import SignalLibrary
import pandas as pd
import numpy as np

class TestSignalLibrary(unittest.TestCase):
    """ä¿¡å·åº“å•å…ƒæµ‹è¯•"""
    
    def setUp(self):
        """æµ‹è¯•å‰å‡†å¤‡"""
        self.signal_lib = SignalLibrary(initial_balance=100000)
        
        # åˆ›å»ºæµ‹è¯•æ•°æ®
        dates = pd.date_range('2023-01-01', periods=100, freq='D')
        prices = 20 + np.cumsum(np.random.randn(100) * 0.1)
        
        self.test_df = pd.DataFrame({
            'date': dates,
            'OPEN': prices * 0.99,
            'HIGH': prices * 1.02,
            'LOW': prices * 0.98,
            'CLOSE': prices,
            'VOLUME': np.random.randint(10000, 50000, 100)
        })
    
    def test_buy_signal_generation(self):
        """æµ‹è¯•ä¹°å…¥ä¿¡å·ç”Ÿæˆ"""
        signals = self.signal_lib.generate_buy_signal(
            '000001', self.test_df, 'basic'
        )
        
        # éªŒè¯ä¿¡å·æ ¼å¼
        self.assertIsInstance(signals, pd.Series)
        self.assertEqual(len(signals), len(self.test_df))
        
        # éªŒè¯ä¿¡å·å€¼
        signal_values = signals.dropna().unique()
        for value in signal_values:
            self.assertEqual(value, 15)  # ä¹°å…¥ä¿¡å·ä»£ç 
    
    def test_buy_trade_execution(self):
        """æµ‹è¯•ä¹°å…¥äº¤æ˜“æ‰§è¡Œ"""
        result = self.signal_lib.execute_buy_trade('000001', 20.0, 100, '2023-01-01')
        
        # éªŒè¯äº¤æ˜“æˆåŠŸ
        self.assertTrue(result['success'])
        self.assertEqual(result['shares'], 100)
        self.assertEqual(result['price'], 20.0)
        
        # éªŒè¯è´¦æˆ·çŠ¶æ€
        self.assertLess(self.signal_lib.current_balance, 100000)
        self.assertIn('000001', self.signal_lib.positions)
    
    def test_insufficient_funds(self):
        """æµ‹è¯•èµ„é‡‘ä¸è¶³æƒ…å†µ"""
        # å°è¯•ä¹°å…¥è¶…å‡ºèµ„é‡‘çš„è‚¡ç¥¨
        result = self.signal_lib.execute_buy_trade('000001', 1000.0, 1000, '2023-01-01')
        
        # åº”è¯¥è‡ªåŠ¨è°ƒæ•´ä¸ºæœ€å¤§å¯ä¹°æ•°é‡ï¼Œæˆ–è¿”å›å¤±è´¥
        if result['success']:
            # è‡ªåŠ¨è°ƒæ•´æ•°é‡
            self.assertLess(result['shares'], 1000)
        else:
            # èµ„é‡‘ä¸è¶³ï¼Œæ‹’ç»äº¤æ˜“
            self.assertIn('èµ„é‡‘ä¸è¶³', result['reason'])

if __name__ == '__main__':
    unittest.main()
```

**é›†æˆæµ‹è¯•ç¤ºä¾‹**

```python
def test_complete_workflow():
    """å®Œæ•´å·¥ä½œæµç¨‹é›†æˆæµ‹è¯•"""
    
    # 1. åˆ›å»ºä¿¡å·åº“
    signal_lib = SignalLibrary(100000)
    
    # 2. åŠ è½½æµ‹è¯•æ•°æ®
    df = pd.read_csv('000001_10years.csv')
    
    # 3. ç”Ÿæˆä¿¡å·
    buy_signals = signal_lib.generate_buy_signal('000001', df, 'smart')
    sell_signals = signal_lib.generate_sell_signal('000001', df, 'smart')
    
    # 4. éªŒè¯ä¿¡å·
    assert buy_signals.notna().sum() > 0, "åº”è¯¥ç”Ÿæˆä¹°å…¥ä¿¡å·"
    assert sell_signals.notna().sum() > 0, "åº”è¯¥ç”Ÿæˆå–å‡ºä¿¡å·"
    
    # 5. æ£€æŸ¥è´¦æˆ·çŠ¶æ€
    summary = signal_lib.get_account_summary()
    assert summary['total_trades'] > 0, "åº”è¯¥æœ‰äº¤æ˜“è®°å½•"
    
    print("âœ… å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•é€šè¿‡")
```

---

## ğŸ”§ å¸¸è§å¼€å‘ä»»åŠ¡

### 1. æ·»åŠ æ–°çš„æŠ€æœ¯æŒ‡æ ‡

**Step 1: åˆ›å»ºæŒ‡æ ‡æ–‡ä»¶**

```python
# indicators/rsi.py
import pandas as pd

def calculate(df, period=14):
    """
    è®¡ç®— RSI (ç›¸å¯¹å¼ºå¼±æŒ‡æ ‡)
    
    Args:
        df: åŒ…å« CLOSE åˆ—çš„ DataFrame
        period: è®¡ç®—å‘¨æœŸï¼Œé»˜è®¤ 14
        
    Returns:
        pd.Series: RSI å€¼åºåˆ— (0-100)
    """
    close = df['CLOSE']
    
    # è®¡ç®—ä»·æ ¼å˜åŒ–
    delta = close.diff()
    
    # åˆ†ç¦»ä¸Šæ¶¨å’Œä¸‹è·Œ
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    
    # è®¡ç®—å¹³å‡æ¶¨è·Œå¹…
    avg_gain = gain.rolling(window=period).mean()
    avg_loss = loss.rolling(window=period).mean()
    
    # è®¡ç®— RSI
    rs = avg_gain / avg_loss
    rsi = 100 - (100 / (1 + rs))
    
    return rsi

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    import pandas as pd
    
    # æµ‹è¯•æ•°æ®
    df = pd.DataFrame({
        'CLOSE': [20, 21, 19, 22, 23, 21, 24, 26, 25, 27]
    })
    
    rsi = calculate(df, period=5)
    print(f"RSI å€¼: {rsi.iloc[-1]:.2f}")
```

**Step 2: åœ¨ä¿¡å·åº“ä¸­ä½¿ç”¨**

```python
# signal_library.py
def _rsi_buy_signal(self, stock_code, df, **kwargs):
    """åŸºäº RSI çš„ä¹°å…¥ä¿¡å·"""
    oversold_threshold = kwargs.get('oversold_threshold', 30)
    period = kwargs.get('rsi_period', 14)
    
    try:
        # å¯¼å…¥ RSI æŒ‡æ ‡
        from indicators import rsi
        
        # è®¡ç®— RSI
        rsi_values = rsi.calculate(df, period=period)
        
        # RSI ä»è¶…å–åŒºåŸŸå‘ä¸Šçªç ´
        buy_condition = ((rsi_values.shift(1) <= oversold_threshold) & 
                        (rsi_values > oversold_threshold))
        
        signals = buy_condition.apply(lambda x: SIGNAL_CODES['buy_signal'] if x else None)
        
        # è®°å½•ä¿¡å·
        for idx, signal in signals.items():
            if signal == SIGNAL_CODES['buy_signal']:
                self._record_signal(stock_code, 'buy', 'rsi_oversold', df.loc[idx], idx)
        
        return signals
        
    except Exception as e:
        print(f"RSI ä¹°å…¥ä¿¡å·è®¡ç®—å¤±è´¥: {e}")
        return pd.Series([None] * len(df), index=df.index)

# åœ¨ generate_buy_signal ä¸­æ·»åŠ æ–°ç­–ç•¥
def generate_buy_signal(self, stock_code, df, signal_type='basic', **kwargs):
    if signal_type == 'rsi_oversold':
        return self._rsi_buy_signal(stock_code, df, **kwargs)
    # ... å…¶ä»–ç­–ç•¥
```

### 2. æ·»åŠ æ–°çš„ API æ¥å£

**Step 1: åˆ›å»ºè§†å›¾å‡½æ•°**

```python
# backtest_integration.py
@standardized_api_response
def get_technical_indicators_api(request):
    """
    è·å–æŠ€æœ¯æŒ‡æ ‡æ•°æ® API
    
    GET /api/indicators/?stock_code=000001&indicators=ma,rsi,macd
    """
    try:
        stock_code = request.GET.get('stock_code')
        indicators_param = request.GET.get('indicators', 'ma,rsi,macd')
        
        if not stock_code:
            raise ValidationError("è‚¡ç¥¨ä»£ç ä¸èƒ½ä¸ºç©º")
        
        # è§£ææŒ‡æ ‡åˆ—è¡¨
        indicator_list = indicators_param.split(',')
        
        # åŠ è½½è‚¡ç¥¨æ•°æ®
        df = load_stock_data(stock_code)
        
        # è®¡ç®—æŒ‡æ ‡
        result = {}
        for indicator in indicator_list:
            if indicator == 'ma':
                result['ma5'] = df['CLOSE'].rolling(5).mean().tolist()
                result['ma20'] = df['CLOSE'].rolling(20).mean().tolist()
            elif indicator == 'rsi':
                from indicators import rsi
                result['rsi'] = rsi.calculate(df).tolist()
            elif indicator == 'macd':
                from indicators import macd
                dif, dea, macd_hist = macd.calculate(df)
                result['macd'] = {
                    'dif': dif.tolist(),
                    'dea': dea.tolist(),
                    'histogram': macd_hist.tolist()
                }
        
        return {
            'stock_code': stock_code,
            'indicators': result,
            'dates': df['date'].dt.strftime('%Y-%m-%d').tolist()
        }
        
    except Exception as e:
        raise Exception(f"æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å¤±è´¥: {e}")
```

**Step 2: æ·»åŠ  URL è·¯ç”±**

```python
# myproject/urls.py
from django.urls import path
from backtest_integration import get_technical_indicators_api

urlpatterns = [
    path('api/backtest/config/', get_backtest_config_api, name='backtest_config'),
    path('api/backtest/run/', run_backtest_api, name='run_backtest'),
    path('api/indicators/', get_technical_indicators_api, name='technical_indicators'),  # æ–°å¢
]
```

**Step 3: å‰ç«¯è°ƒç”¨**

```javascript
// frontend/src/js/api.js
async function getTechnicalIndicators(stockCode, indicators = ['ma', 'rsi', 'macd']) {
    const params = new URLSearchParams({
        stock_code: stockCode,
        indicators: indicators.join(',')
    });
    
    const response = await fetch(`${API_BASE_URL}/api/indicators/?${params}`);
    
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.status === 'error') {
        throw new Error(data.message);
    }
    
    return data.data;
}

// ä½¿ç”¨ç¤ºä¾‹
async function displayIndicators() {
    try {
        const data = await getTechnicalIndicators('000001', ['ma', 'rsi']);
        console.log('æŠ€æœ¯æŒ‡æ ‡æ•°æ®:', data);
        
        // æ›´æ–°å›¾è¡¨æˆ–è¡¨æ ¼
        updateChart(data);
        
    } catch (error) {
        console.error('è·å–æŠ€æœ¯æŒ‡æ ‡å¤±è´¥:', error);
        showErrorMessage('è·å–æŠ€æœ¯æŒ‡æ ‡å¤±è´¥: ' + error.message);
    }
}
```

### 3. æ•°æ®æºæ‰©å±•

**æ·»åŠ æ–°çš„æ•°æ®æºæ¥å£**

```python
# data_sources/yahoo_finance.py
import yfinance as yf
import pandas as pd

class YahooFinanceSource:
    """Yahoo Finance æ•°æ®æº"""
    
    def __init__(self):
        self.name = "Yahoo Finance"
    
    def get_stock_data(self, symbol, start_date=None, end_date=None):
        """
        è·å–è‚¡ç¥¨æ•°æ®
        
        Args:
            symbol: è‚¡ç¥¨ä»£ç  (å¦‚ '000001.SZ')
            start_date: å¼€å§‹æ—¥æœŸ
            end_date: ç»“æŸæ—¥æœŸ
            
        Returns:
            pd.DataFrame: æ ‡å‡†æ ¼å¼çš„è‚¡ç¥¨æ•°æ®
        """
        try:
            # ä¸‹è½½æ•°æ®
            ticker = yf.Ticker(symbol)
            df = ticker.history(start=start_date, end=end_date)
            
            # è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
            df = df.reset_index()
            df = df.rename(columns={
                'Date': 'date',
                'Open': 'OPEN',
                'High': 'HIGH',
                'Low': 'LOW',
                'Close': 'CLOSE',
                'Volume': 'VOLUME'
            })
            
            return df
            
        except Exception as e:
            raise Exception(f"Yahoo Finance æ•°æ®è·å–å¤±è´¥: {e}")
    
    def validate_symbol(self, symbol):
        """éªŒè¯è‚¡ç¥¨ä»£ç """
        try:
            ticker = yf.Ticker(symbol)
            info = ticker.info
            return info.get('symbol') is not None
        except:
            return False

# æ•°æ®æºç®¡ç†å™¨
class DataSourceManager:
    """æ•°æ®æºç®¡ç†å™¨"""
    
    def __init__(self):
        self.sources = {
            'csv': CSVDataSource(),
            'tushare': TushareDataSource(),
            'yahoo': YahooFinanceSource(),
        }
        self.default_source = 'csv'
    
    def get_stock_data(self, symbol, source=None, **kwargs):
        """
        ä»æŒ‡å®šæ•°æ®æºè·å–è‚¡ç¥¨æ•°æ®
        """
        if source is None:
            source = self.default_source
        
        if source not in self.sources:
            raise ValueError(f"ä¸æ”¯æŒçš„æ•°æ®æº: {source}")
        
        return self.sources[source].get_stock_data(symbol, **kwargs)
    
    def add_source(self, name, source_instance):
        """æ·»åŠ æ–°çš„æ•°æ®æº"""
        self.sources[name] = source_instance

# ä½¿ç”¨ç¤ºä¾‹
data_manager = DataSourceManager()

# ä»ä¸åŒæ•°æ®æºè·å–æ•°æ®
csv_data = data_manager.get_stock_data('000001', source='csv')
yahoo_data = data_manager.get_stock_data('000001.SZ', source='yahoo', 
                                       start_date='2023-01-01')
```

---

## ğŸ› è°ƒè¯•æŠ€å·§

### 1. å¸¸ç”¨è°ƒè¯•æ–¹æ³•

**ä½¿ç”¨ Python å†…ç½®è°ƒè¯•å™¨**

```python
import pdb

def debug_signal_generation():
    """è°ƒè¯•ä¿¡å·ç”Ÿæˆè¿‡ç¨‹"""
    signal_lib = SignalLibrary()
    df = load_test_data()
    
    # è®¾ç½®æ–­ç‚¹
    pdb.set_trace()
    
    # å•æ­¥æ‰§è¡Œä¿¡å·ç”Ÿæˆ
    signals = signal_lib.generate_buy_signal('000001', df, 'macd_golden')
    
    # æ£€æŸ¥ä¸­é—´ç»“æœ
    print(f"ç”Ÿæˆä¿¡å·æ•°: {signals.notna().sum()}")
    print(f"ä¿¡å·ä½ç½®: {signals.dropna().index.tolist()}")
```

**ä½¿ç”¨æ—¥å¿—è°ƒè¯•**

```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('debug.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

def debug_with_logging():
    """ä½¿ç”¨æ—¥å¿—è°ƒè¯•"""
    logger.debug("å¼€å§‹ä¿¡å·ç”Ÿæˆ")
    
    try:
        # ä¸šåŠ¡é€»è¾‘
        result = generate_signals()
        logger.info(f"ä¿¡å·ç”ŸæˆæˆåŠŸ: {len(result)}")
        
    except Exception as e:
        logger.error(f"ä¿¡å·ç”Ÿæˆå¤±è´¥: {e}", exc_info=True)
```

**æ€§èƒ½åˆ†æ**

```python
import time
import cProfile

def profile_signal_generation():
    """æ€§èƒ½åˆ†æä¿¡å·ç”Ÿæˆ"""
    
    def run_test():
        signal_lib = SignalLibrary()
        df = load_large_dataset()  # å¤§æ•°æ®é›†
        
        start_time = time.time()
        signals = signal_lib.generate_buy_signal('000001', df, 'smart')
        end_time = time.time()
        
        print(f"æ‰§è¡Œæ—¶é—´: {end_time - start_time:.2f} ç§’")
        return signals
    
    # è¯¦ç»†æ€§èƒ½åˆ†æ
    cProfile.run('run_test()', 'profile_results.txt')

# æŸ¥çœ‹åˆ†æç»“æœ
# python -c "import pstats; p = pstats.Stats('profile_results.txt'); p.sort_stats('time').print_stats(20)"
```

### 2. å‰ç«¯è°ƒè¯•

**æµè§ˆå™¨å¼€å‘è€…å·¥å…·**

```javascript
// æ·»åŠ è°ƒè¯•è¾“å‡º
function debugApiCall() {
    console.group('API è°ƒç”¨è°ƒè¯•');
    
    fetch('/api/backtest/config/')
        .then(response => {
            console.log('å“åº”çŠ¶æ€:', response.status);
            console.log('å“åº”å¤´:', response.headers);
            return response.json();
        })
        .then(data => {
            console.log('å“åº”æ•°æ®:', data);
            console.table(data.available_stocks);  // è¡¨æ ¼å½¢å¼æ˜¾ç¤º
        })
        .catch(error => {
            console.error('è¯·æ±‚å¤±è´¥:', error);
        })
        .finally(() => {
            console.groupEnd();
        });
}

// ç½‘ç»œè¯·æ±‚ç›‘æ§
function monitorNetworkRequests() {
    const originalFetch = window.fetch;
    
    window.fetch = function(...args) {
        console.log('å‘èµ·è¯·æ±‚:', args[0]);
        
        return originalFetch.apply(this, args)
            .then(response => {
                console.log(`è¯·æ±‚å®Œæˆ: ${args[0]} - ${response.status}`);
                return response;
            });
    };
}
```

### 3. API è°ƒè¯•

**ä½¿ç”¨ Django Debug Toolbar**

```python
# settings.py
if DEBUG:
    INSTALLED_APPS += ['debug_toolbar']
    MIDDLEWARE += ['debug_toolbar.middleware.DebugToolbarMiddleware']
    
    INTERNAL_IPS = ['127.0.0.1']
    
    DEBUG_TOOLBAR_CONFIG = {
        'SHOW_TOOLBAR_CALLBACK': lambda request: True,
    }

# urls.py  
if settings.DEBUG:
    import debug_toolbar
    urlpatterns += [path('__debug__/', include(debug_toolbar.urls))]
```

**API å“åº”æ—¶é—´ç›‘æ§**

```python
import time
from functools import wraps

def monitor_api_performance(func):
    """ç›‘æ§ API æ€§èƒ½è£…é¥°å™¨"""
    @wraps(func)
    def wrapper(request, *args, **kwargs):
        start_time = time.time()
        
        try:
            response = func(request, *args, **kwargs)
            
            end_time = time.time()
            duration = end_time - start_time
            
            # è®°å½•æ€§èƒ½æ•°æ®
            logger.info(f"API æ€§èƒ½: {request.path} - {duration:.3f}s")
            
            # æ…¢æŸ¥è¯¢è­¦å‘Š
            if duration > 2.0:
                logger.warning(f"æ…¢æŸ¥è¯¢è­¦å‘Š: {request.path} è€—æ—¶ {duration:.3f}s")
            
            return response
            
        except Exception as e:
            end_time = time.time()
            duration = end_time - start_time
            logger.error(f"API å¼‚å¸¸: {request.path} - {duration:.3f}s - {e}")
            raise
    
    return wrapper

# ä½¿ç”¨è£…é¥°å™¨
@monitor_api_performance
def run_backtest_api(request):
    # API é€»è¾‘
    pass
```

---

## ğŸ“š å­¦ä¹ èµ„æº

### 1. æŠ€æœ¯æ–‡æ¡£

**Django ç›¸å…³**
- [Django å®˜æ–¹æ–‡æ¡£](https://docs.djangoproject.com/)
- [Django REST Framework](https://www.django-rest-framework.org/)
- [Django CORS Headers](https://github.com/adamchainz/django-cors-headers)

**æ•°æ®åˆ†æç›¸å…³**
- [Pandas å®˜æ–¹æ–‡æ¡£](https://pandas.pydata.org/docs/)
- [NumPy ç”¨æˆ·æŒ‡å—](https://numpy.org/doc/stable/user/)
- [æŠ€æœ¯æŒ‡æ ‡è®¡ç®—æ–¹æ³•](https://technical-analysis-library-in-python.readthedocs.io/)

**é‡åŒ–äº¤æ˜“ç›¸å…³**
- [Quantlib Python](https://quantlib-python-docs.readthedocs.io/)
- [Backtrader æ–‡æ¡£](https://www.backtrader.com/docu/)
- [TuShare æ–‡æ¡£](https://tushare.pro/document/2)

### 2. ä»£ç ç¤ºä¾‹

**å®Œæ•´çš„å¼€å‘ç¤ºä¾‹**

```python
"""
ç¤ºä¾‹: å¼€å‘ä¸€ä¸ªæ–°çš„æŠ€æœ¯æŒ‡æ ‡å’Œå¯¹åº”çš„äº¤æ˜“ç­–ç•¥

ä»»åŠ¡: å®ç° Bollinger Bands (å¸ƒæ—å¸¦) æŒ‡æ ‡å’ŒåŸºäºå¸ƒæ—å¸¦çš„äº¤æ˜“ç­–ç•¥
"""

# Step 1: å®ç°æŠ€æœ¯æŒ‡æ ‡
# indicators/bollinger_bands.py
import pandas as pd
import numpy as np

def calculate(df, period=20, std_dev=2):
    """
    è®¡ç®—å¸ƒæ—å¸¦æŒ‡æ ‡
    
    Args:
        df: åŒ…å« CLOSE åˆ—çš„ DataFrame
        period: ç§»åŠ¨å¹³å‡å‘¨æœŸ
        std_dev: æ ‡å‡†å·®å€æ•°
        
    Returns:
        tuple: (upper_band, middle_band, lower_band)
    """
    close = df['CLOSE']
    
    # ä¸­è½¨: ç®€å•ç§»åŠ¨å¹³å‡
    middle_band = close.rolling(window=period).mean()
    
    # æ ‡å‡†å·®
    rolling_std = close.rolling(window=period).std()
    
    # ä¸Šè½¨å’Œä¸‹è½¨
    upper_band = middle_band + (rolling_std * std_dev)
    lower_band = middle_band - (rolling_std * std_dev)
    
    return upper_band, middle_band, lower_band

# Step 2: åœ¨ä¿¡å·åº“ä¸­å®ç°ç­–ç•¥
# signal_library.py (æ·»åŠ æ–¹æ³•)
def _bollinger_buy_signal(self, stock_code, df, **kwargs):
    """å¸ƒæ—å¸¦ä¹°å…¥ä¿¡å·: ä»·æ ¼ä»ä¸‹è½¨åå¼¹"""
    period = kwargs.get('bb_period', 20)
    std_dev = kwargs.get('bb_std_dev', 2)
    
    from indicators import bollinger_bands
    
    upper_band, middle_band, lower_band = bollinger_bands.calculate(
        df, period=period, std_dev=std_dev
    )
    
    close = df['CLOSE']
    
    # ä¹°å…¥æ¡ä»¶: ä»·æ ¼è§¦åŠä¸‹è½¨ååå¼¹
    touch_lower = close <= lower_band
    bounce_up = (close.shift(1) <= lower_band.shift(1)) & (close > lower_band)
    
    buy_condition = touch_lower.shift(1) & bounce_up
    
    signals = buy_condition.apply(lambda x: SIGNAL_CODES['buy_signal'] if x else None)
    
    # è®°å½•ä¿¡å·
    for idx, signal in signals.items():
        if signal == SIGNAL_CODES['buy_signal']:
            self._record_signal(stock_code, 'buy', 'bollinger_bounce', df.loc[idx], idx)
    
    return signals

def _bollinger_sell_signal(self, stock_code, df, **kwargs):
    """å¸ƒæ—å¸¦å–å‡ºä¿¡å·: ä»·æ ¼è§¦åŠä¸Šè½¨"""
    period = kwargs.get('bb_period', 20)
    std_dev = kwargs.get('bb_std_dev', 2)
    
    from indicators import bollinger_bands
    
    upper_band, middle_band, lower_band = bollinger_bands.calculate(
        df, period=period, std_dev=std_dev
    )
    
    close = df['CLOSE']
    
    # å–å‡ºæ¡ä»¶: ä»·æ ¼è§¦åŠæˆ–çªç ´ä¸Šè½¨
    sell_condition = close >= upper_band
    
    signals = sell_condition.apply(lambda x: SIGNAL_CODES['sell_signal'] if x else None)
    
    # è®°å½•ä¿¡å·
    for idx, signal in signals.items():
        if signal == SIGNAL_CODES['sell_signal']:
            self._record_signal(stock_code, 'sell', 'bollinger_upper', df.loc[idx], idx)
    
    return signals

# Step 3: åœ¨ä¸»è¦æ–¹æ³•ä¸­æ·»åŠ æ–°ç­–ç•¥
def generate_buy_signal(self, stock_code, df, signal_type='basic', **kwargs):
    if signal_type == 'bollinger_bounce':
        return self._bollinger_buy_signal(stock_code, df, **kwargs)
    # ... å…¶ä»–ç­–ç•¥

def generate_sell_signal(self, stock_code, df, signal_type='basic', **kwargs):
    if signal_type == 'bollinger_upper':
        return self._bollinger_sell_signal(stock_code, df, **kwargs)
    # ... å…¶ä»–ç­–ç•¥

# Step 4: æµ‹è¯•æ–°ç­–ç•¥
def test_bollinger_strategy():
    """æµ‹è¯•å¸ƒæ—å¸¦ç­–ç•¥"""
    signal_lib = SignalLibrary(100000)
    df = pd.read_csv('000001_10years.csv')
    
    # ç”Ÿæˆä¹°å…¥ä¿¡å·
    buy_signals = signal_lib.generate_buy_signal(
        '000001', df, 'bollinger_bounce',
        bb_period=20, bb_std_dev=2
    )
    
    # ç”Ÿæˆå–å‡ºä¿¡å·
    sell_signals = signal_lib.generate_sell_signal(
        '000001', df, 'bollinger_upper',
        bb_period=20, bb_std_dev=2
    )
    
    print(f"å¸ƒæ—å¸¦ä¹°å…¥ä¿¡å·: {buy_signals.notna().sum()}")
    print(f"å¸ƒæ—å¸¦å–å‡ºä¿¡å·: {sell_signals.notna().sum()}")
    
    # æŸ¥çœ‹äº¤æ˜“ç»“æœ
    summary = signal_lib.get_trading_summary('000001')
    print(f"ç­–ç•¥æ”¶ç›Šç‡: {summary['profit_rate']:.2f}%")

if __name__ == '__main__':
    test_bollinger_strategy()
```

### 3. æœ€ä½³å®è·µæ€»ç»“

**å¼€å‘æµç¨‹æœ€ä½³å®è·µ**

1. **éœ€æ±‚åˆ†æ** â†’ æ˜ç¡®åŠŸèƒ½éœ€æ±‚å’ŒæŠ€æœ¯è¦æ±‚
2. **æŠ€æœ¯è®¾è®¡** â†’ è®¾è®¡ API æ¥å£å’Œæ•°æ®ç»“æ„  
3. **å•å…ƒæµ‹è¯•** â†’ ç¼–å†™æµ‹è¯•ç”¨ä¾‹
4. **åŠŸèƒ½å®ç°** â†’ å®ç°æ ¸å¿ƒé€»è¾‘
5. **é›†æˆæµ‹è¯•** â†’ æµ‹è¯•å®Œæ•´æµç¨‹
6. **æ€§èƒ½ä¼˜åŒ–** â†’ åˆ†æå’Œä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ
7. **æ–‡æ¡£æ›´æ–°** â†’ æ›´æ–°ç›¸å…³æ–‡æ¡£

**ä»£ç è´¨é‡æ£€æŸ¥æ¸…å•**

- [ ] ä»£ç ç¬¦åˆ PEP 8 è§„èŒƒ
- [ ] å‡½æ•°å’Œç±»æœ‰å®Œæ•´çš„æ–‡æ¡£å­—ç¬¦ä¸²
- [ ] å…³é”®é€»è¾‘æœ‰é€‚å½“çš„æ³¨é‡Š
- [ ] å¼‚å¸¸å¤„ç†è¦†ç›–ä¸»è¦é”™è¯¯åœºæ™¯
- [ ] æœ‰å¯¹åº”çš„å•å…ƒæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] API æ¥å£æ–‡æ¡£å·²æ›´æ–°

---

## ğŸš€ éƒ¨ç½²ä¸å‘å¸ƒ

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ£€æŸ¥æ¸…å•

**å®‰å…¨é…ç½®**
- [ ] DEBUG = False
- [ ] SECRET_KEY ä½¿ç”¨ç¯å¢ƒå˜é‡
- [ ] æ•°æ®åº“å¯†ç ä½¿ç”¨ç¯å¢ƒå˜é‡
- [ ] HTTPS é…ç½®
- [ ] CORS ç­–ç•¥é™åˆ¶
- [ ] API è®¿é—®é¢‘ç‡é™åˆ¶

**æ€§èƒ½é…ç½®**
- [ ] æ•°æ®åº“è¿æ¥æ± é…ç½®
- [ ] é™æ€æ–‡ä»¶ CDN é…ç½®
- [ ] Redis ç¼“å­˜é…ç½®
- [ ] æ—¥å¿—æ–‡ä»¶è½®è½¬é…ç½®
- [ ] ç›‘æ§å‘Šè­¦é…ç½®

**å¤‡ä»½ç­–ç•¥**
- [ ] æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½
- [ ] ä»£ç ç‰ˆæœ¬ç®¡ç†
- [ ] é…ç½®æ–‡ä»¶å¤‡ä»½
- [ ] æ—¥å¿—æ–‡ä»¶å½’æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-08-04  
**ç»´æŠ¤è€…**: ç³»ç»Ÿé›†æˆå›¢é˜Ÿ

ğŸ“§ **æŠ€æœ¯æ”¯æŒ**: é€šè¿‡ GitHub Issues æäº¤é—®é¢˜  
ğŸ”„ **æŒç»­æ›´æ–°**: æœ¬æ–‡æ¡£å°†éšé¡¹ç›®å‘å±•æŒç»­æ›´æ–°
